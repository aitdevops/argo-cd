name: Deploy to GKE

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v3

    
    - name: Set up Google Cloud auth
      uses: google-github-actions/auth@v1
      with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS }}  # Authenticates to Google Cloud using service account credentials

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.PROJECT_ID }}
        service_account_key: ${{ secrets.SA_KEY }}
        export_default_credentials: true
        install_components: kubectl  # Installs the 'kubectl' component for interacting with Kubernetes clusters


    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials ${{ secrets.CLUSTER_NAME }} --zone ${{ secrets.CLUSTER_ZONE }} --project ${{ secrets.PROJECT_ID }}

    - name: Set up Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

    - name: Deploy cert-manager using Helm
      run: |
        helm repo add jetstack https://charts.jetstack.io
        helm repo update
        helm upgrade --install cert-manager jetstack/cert-manager \
          --namespace cert-manager --create-namespace \
          --version v1.15.3 --set crds.enabled=true

    - name: Deploy ArgoCD using Helm
      run: |
        helm repo add argo https://argoproj.github.io/argo-helm
        helm repo update
        helm upgrade --install argocd argo/argo-cd \
          --namespace argocd --create-namespace \
          --version 5.24.0

    - name: Deploy NGINX Ingress Controller using Helm
      run: |
        helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
        helm repo update
        helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
          --namespace ingress-nginx --create-namespace \
          --version 4.7.0

    - name: Monitor Resources
      run: |
        kubectl get all --namespace cert-manager
        kubectl get all --namespace argocd
        kubectl get all --namespace ingress-nginx

    - name: Rollback on Failure
      if: failure()
      run: |
        echo "Deployment failed. Rolling back..."
        helm rollback cert-manager --namespace cert-manager
        helm rollback argocd --namespace argocd
        helm rollback ingress-nginx --namespace ingress-nginx

    - name: Notify on Success
      if: success()
      run: echo "Deployment successful!"

    - name: Notify on Failure
      if: failure()
      run: echo "Deployment failed!"
